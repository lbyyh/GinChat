<!DOCTYPE html>
<html>
<link rel="stylesheet" href="/asset/css/chat.css">
<head>
    <style>
        /* èŠå¤©æ¶ˆæ¯çš„é€šç”¨æ ·å¼ */
        .message-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        /* æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼ˆå¤´åƒé å·¦ï¼‰ */
        .friend-message .contact-avatar {
            margin-right: 10px;
        }

        /* å‘é€çš„æ¶ˆæ¯ï¼ˆå¤´åƒé å³ï¼‰ */
        .my-message {
            justify-content: flex-end;
        }

        .my-message .contact-avatar {
            margin-left: 10px;
            order: 2; /* å°†å¤´åƒç§»åŠ¨åˆ°å†…å®¹çš„å³è¾¹ */
        }

        .my-message .message-content {
            order: 1; /* ç¡®ä¿æ¶ˆæ¯å†…å®¹åœ¨å¤´åƒçš„å·¦è¾¹ */
        }

        .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 20px; /* åœ†å½¢å¤´åƒ */
        }

        .message-content {
            max-width: 60%;
            /* æ·»åŠ å¿…è¦çš„æ ·å¼ */
        }
        #voiceMode {
            display: none;
        }
        /* å½•éŸ³æŒ‰é’®æ ·å¼ */
        #voiceInputBtn {
            margin: 5px;
        }
        /* å½•éŸ³ä¸­æŒ‡ç¤ºå™¨æ ·å¼ */
        #recordingIndicator {
            color: red;
        }

        .hold-to-record {
            background-color: #ff4d4f;
            color: white;
            border-radius: 20px;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
        }

        .recordingIndicator {
            display: none; /* é»˜è®¤éšè—ï¼Œå½•éŸ³æ—¶æ˜¾ç¤º */
        }

        .recordingIndicator.active {
            display: block;
            color: #ff4d4f;
            text-align: center;
        }
    </style>
    <link rel="stylesheet" href="/asset/css/style.css">
    <title>ç¾¤èŠ</title>
</head>
<body>
<div class="chat-header">
    <div class="back-arrow">&#x2190;</div>
    <div class="chat-title">ç¾¤èŠåç§°</div>
</div>
<div class="chat-messages" id="chat-messages">
    <!-- èŠå¤©è®°å½•åŠ¨æ€å¡«å……åŒºåŸŸ -->
</div>
<div class="chat-input-area">
    <input type="file" id="imageInput" hidden />
    <button id="emojiBtn">ğŸ˜Š</button>
    <button id="imageBtn">ğŸ“·</button>
    <button id="toggleVoiceModeBtn">ğŸ¤</button>
    <div id="voiceMode" class="input-mode" style="display: none;">
        <button id="voiceInputBtn">æŒ‰ä½è¯´è¯</button>
        <span id="recordingIndicator">å½•éŸ³ä¸­...</span>
    </div>
    <div id="textMode" class="input-mode">
        <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯...">
        <button id="sendBtn">å‘é€</button>
        <!-- å…¶ä»–æ–‡æœ¬è¾“å…¥ç›¸å…³æŒ‰é’® -->
    </div>
</div>

<script>

    const userId = getUserIdFromURL();  // æ­¤å‡½æ•°éœ€è¦å®ç°ï¼Œä»URLå‚æ•°è·å–userId
    const groupId = getGroupIdFromURL();  // æ­¤å‡½æ•°éœ€è¦å®ç°ï¼Œä»URLå‚æ•°è·å–groupId

    // èŠå¤©ç•Œé¢çš„åŠŸèƒ½æ ¸å¿ƒä»£ç 
    document.addEventListener('DOMContentLoaded', () => {
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const imageBtn = document.getElementById('imageBtn');
        const imageInput = document.getElementById('imageInput');
        const emojiBtn = document.getElementById('emojiBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const voiceButton = document.getElementById('voiceInputBtn');
        const recordingIndicator = document.getElementById('recordingIndicator');

        // å¤„ç†â€œé•¿æŒ‰å½•éŸ³â€æŒ‰é’®çš„è§¦æ‘¸äº‹ä»¶
        voiceButton.addEventListener('touchstart', (e) => {
            e.preventDefault();  // é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œå¦‚æ»šåŠ¨
            recordingIndicator.style.display = '';  // æ˜¾ç¤ºå½•éŸ³æŒ‡ç¤ºå™¨
            startRecording();  // å¼€å§‹å½•éŸ³
        });

        voiceButton.addEventListener('touchend', (e) => {
            recordingIndicator.style.display = 'none';  // éšè—å½•éŸ³æŒ‡ç¤ºå™¨
            stopRecording();  // åœæ­¢å½•éŸ³
        });

        // å¤„ç†é•¿æŒ‰äº‹ä»¶ï¼ˆç¤ºä¾‹ä½¿ç”¨mousedownå’Œmouseupäº‹ä»¶æ¥æ¨¡æ‹Ÿï¼‰
        let recording = false; // è®°å½•æ˜¯å¦æ­£åœ¨å½•éŸ³
        voiceButton.addEventListener('mousedown', startRecording);
        voiceButton.addEventListener('mouseup', stopRecording);
        voiceButton.addEventListener('mouseleave', stopRecording); // å½“é¼ æ ‡ç¦»å¼€æŒ‰é’®æ—¶ä¹Ÿåœæ­¢å½•éŸ³



        // è¿”å›æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        document.querySelector('.back-arrow').addEventListener('click', () => {
            window.history.back();
        });

        // è·å–ç¾¤èŠåç§°å¹¶æ˜¾ç¤º
        groupName = decodeURIComponent(new URLSearchParams(window.location.search).get('groupName') || 'ç¾¤èŠ');
        document.querySelector('.chat-title').textContent = groupName;

        // ç›¸å…³åˆå§‹åŒ–ä»£ç ï¼Œå¦‚WebSocketè¿æ¥ç­‰...
        initializeWebSocket()
        // å‘é€æ–‡æœ¬æ¶ˆæ¯
        sendBtn.addEventListener('click', () => {
            const content = messageInput.value.trim();
            if(content) {
                sendMessage(content,2, 1); // å‡è®¾çš„å‡½æ•°ï¼Œå‘é€æ¶ˆæ¯
                messageInput.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
            }
        });

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ å’Œå‘é€
        imageBtn.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('file', file); // ç¡®ä¿è¿™é‡Œçš„keyä¸æœåŠ¡å™¨ç«¯æ¥æ”¶æ–‡ä»¶çš„å­—æ®µç›¸åŒ¹é…

                // è°ƒç”¨ uploadImage å‡½æ•°å¹¶å¤„ç†å“åº”
                uploadImage(formData).then(url => {
                    // ä½¿ç”¨è¿”å›çš„URLæ¥å‘é€å›¾ç‰‡æ¶ˆæ¯
                    sendMessage(url, 2, 3); // å‡è®¾ type: 2 = ç¾¤èŠ, media: 3 = å›¾ç‰‡
                }).catch(error => {
                    console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
                });
            }
        });

        // å¤„ç†è¡¨æƒ…é€‰æ‹©ï¼ˆå‡è®¾emojiBtnè§¦å‘æŸä¸ªè¡¨æƒ…é€‰æ‹©å™¨ï¼‰
        emojiBtn.addEventListener('click', () => {
            // å®ç°è¡¨æƒ…é€‰æ‹©å™¨çš„é€»è¾‘ï¼Œå¯èƒ½éœ€è¦ç¬¬ä¸‰æ–¹åº“æˆ–è‡ªå®šä¹‰UIç»„ä»¶
        });
    });


    // æ·»åŠ "é•¿æŒ‰è¯´è¯"æŒ‰é’®äº‹ä»¶å¤„ç†
    const voiceInputButton = document.getElementById('voiceInputBtn');
    voiceInputButton.addEventListener('mousedown', startRecording);
    voiceInputButton.addEventListener('mouseup', stopRecording);
    voiceInputButton.addEventListener('mouseleave', stopRecording);
    voiceInputButton.addEventListener('touchstart', startRecording);
    voiceInputButton.addEventListener('touchend', stopRecording);

    function startRecording() {
        recordingIndicator.style.display = 'block';  // æ˜¾ç¤ºå½•éŸ³çŠ¶æ€
        recording = true;
        audioChunks = []; // é‡ç½®éŸ³é¢‘ç‰‡æ®µå®¹å™¨
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data); // æ”¶é›†å½•éŸ³æ•°æ®
                };
                mediaRecorder.onstop = () => {
                    recordingIndicator.style.display = 'none';  // éšè—å½•éŸ³çŠ¶æ€
                    const audioBlob = new Blob(audioChunks);
                    uploadAndSendAudio(audioBlob);  // ä¸Šä¼ å¹¶å‘é€å½•éŸ³
                };
                mediaRecorder.start();
            })
            .catch(error => {
                console.error('æ— æ³•å¯åŠ¨å½•éŸ³:', error);
                alert("å½•éŸ³æƒé™è¢«æ‹’ç»æˆ–æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒéŸ³é¢‘å½•åˆ¶ã€‚");
            });
    }

    function stopRecording() {
        if (recording && mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            recording = false;
        }
    }

    document.getElementById('toggleVoiceModeBtn').addEventListener('click', function() {
        const textMode = document.getElementById('textMode');
        const voiceMode = document.getElementById('voiceMode');
        textMode.style.display = 'none';
        voiceMode.style.display = 'block';
    });

    // å½•éŸ³åŠŸèƒ½å®ç°
    let mediaRecorder;
    let isRecording = false;
    document.getElementById('voiceInputBtn').addEventListener('touchstart', startRecording);
    document.getElementById('voiceInputBtn').addEventListener('touchend', stopRecording);

    function startRecording() {
        if (isRecording) return; // å¦‚æœå·²ç»åœ¨å½•éŸ³ï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œ
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.start();
                isRecording = true;
                document.getElementById('recordingIndicator').style.display = 'block';
            })
            .catch(error => {
                console.error('æ— æ³•å¯åŠ¨å½•éŸ³:', error);
            });
    }

    function stopRecording() {
        if (!isRecording) return; // å¦‚æœæ²¡æœ‰åœ¨å½•éŸ³ï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œ
        mediaRecorder.stop();
        isRecording = false;
        document.getElementById('recordingIndicator').style.display = 'none';
        handleRecordingStop();
    }

    let audioChunks = [];
    function handleRecordingStop() {
        // åœæ­¢å½•éŸ³åå¤„ç†éŸ³é¢‘chunks
        const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
        // ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶
        uploadAndSendAudio(audioBlob);
    }





    // ç»‘å®šé•¿æŒ‰è¯´è¯æŒ‰é’®çš„äº‹ä»¶
    document.getElementById('voiceInputBtn').addEventListener('touchstart', startRecording);
    document.getElementById('voiceInputBtn').addEventListener('touchend', stopRecording);



    // å‘é€æ¶ˆæ¯å‡½æ•°è°ƒæ•´
    function sendMessage(content, type, media) {
        const message = {
            TargetId: parseInt(groupId),
            FormId: parseInt(userId),
            Content: content,
            Type: type,
            Media: media,
        };
        if (socket && socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify(message));
        }
        // æ˜¾ç¤ºè‡ªå·±å‘é€çš„æ¶ˆæ¯
        displayMessage({...message, fromSelf: true});
    }

    // å‡è®¾çš„ä¸Šä¼ å›¾ç‰‡å‡½æ•°
    // ä¸Šä¼ å›¾ç‰‡å‡½æ•°æ”¹è¿›
    function uploadImage(formData) {
        return fetch('/attach/upload', {
            method: 'POST',
            body: formData,
        })
            .then(response => response.json())
            .then(data => {
                if(data.url) {
                    return data.url; // è¿”å›ä¸Šä¼ å›¾ç‰‡çš„URL
                } else {
                    throw new Error('æœåŠ¡å™¨æœªè¿”å›å›¾ç‰‡URL');
                }
            })
            .catch(error => {
                console.error('ä¸Šä¼ å¤±è´¥:', error);
                throw error;
            });
    }

    function uploadAndSendAudio(audioBlob) {
        const formData = new FormData();
        formData.append('audio', audioBlob);

        fetch('/user/audioUploadHandler', { method: 'POST', body: formData })
            .then(response => response.json())
            .then(data => {
                if (data.url) {
                    sendMessage(data.url, 2, 4); // å‡è®¾ type: 2 = ç¾¤èŠ, media: 4 = éŸ³é¢‘
                } else {
                    console.error("ä¸Šä¼ å¤±è´¥: æœåŠ¡å™¨æœªè¿”å›éŸ³é¢‘URL");
                }
            })
            .catch(error => console.error('ä¸Šä¼ éŸ³é¢‘å¤±è´¥:', error));
    }

    // ç»™å®šä¸€ä¸ªæ¶ˆæ¯å¯¹è±¡ï¼Œæ˜¾ç¤ºåœ¨èŠå¤©ç•Œé¢ä¸­
    function displayMessage(message) {
        const chatMessages = document.getElementById('chat-messages');
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message-container');

        // åˆ›å»ºå¤´åƒå…ƒç´ 
        const avatarImg = document.createElement('img');
        avatarImg.src = getAvatarUrl(message.senderId); // å‡è®¾æœ‰ä¸€ä¸ªå‡½æ•°è·å–ç”¨æˆ·å¤´åƒURL
        avatarImg.classList.add('contact-avatar');

        // åˆ›å»ºæ¶ˆæ¯å†…å®¹å…ƒç´ 
        const contentDiv = document.createElement('div');
        contentDiv.classList.add('message-content');
        let contentHTML = '';
        switch (message.Media) {
            case 1:
                contentHTML = message.Content;
                break;
            case 3: // å›¾ç‰‡æ¶ˆæ¯
                const img = document.createElement('img');
                img.src = message.Content; // ç¡®ä¿è¿™é‡Œçš„Contentæ˜¯å›¾ç‰‡çš„å®Œæ•´URL
                img.classList.add('chat-img');
                img.onload = function() {
                    messageContainer.appendChild(contentDiv);
                    // å›¾ç‰‡åŠ è½½å®Œæˆåæ·»åŠ åˆ°èŠå¤©ç•Œé¢ä¸­
                    contentDiv.appendChild(img);
                };
                break;
            case 4: // è¯­éŸ³æ¶ˆæ¯
                const audioElement = document.createElement('audio');
                audioElement.controls = true;
                audioElement.src = message.Content;
                messageContentDiv.appendChild(audioElement);
                break;
            // å¯æ ¹æ®éœ€è¦æ·»åŠ å…¶ä»–ç±»å‹å¤„ç†...
        }
        contentDiv.innerHTML = contentHTML;

        // æ ¹æ®æ¶ˆæ¯æ¥æºæ’åºå¤´åƒå’Œæ¶ˆæ¯å†…å®¹
        if(message.fromSelf) {
            messageContainer.classList.add('my-message');
            // è‡ªå·±å‘çš„æ¶ˆæ¯ï¼Œå¤´åƒæ”¾åœ¨å³è¾¹
            messageContainer.appendChild(contentDiv);
            messageContainer.appendChild(avatarImg);
        } else {
            messageContainer.classList.add('friend-message');
            // æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œå¤´åƒæ”¾åœ¨å·¦è¾¹
            messageContainer.appendChild(avatarImg);
            messageContainer.appendChild(contentDiv);
        }

        chatMessages.appendChild(messageContainer);
        chatMessages.scrollTop = chatMessages.scrollHeight; // æ»šåŠ¨åˆ°åº•éƒ¨
    }

    // è·å–å¤´åƒURLçš„å‡è®¾å‡½æ•°
    function getAvatarUrl(userId) {
        // è¿™é‡Œç›´æ¥è¿”å›å‡è®¾çš„å¤´åƒURLã€‚å®é™…é¡¹ç›®ä¸­ï¼Œä½ å¯èƒ½éœ€è¦æ ¹æ®å®é™…å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯è¿”å›å¯¹åº”çš„å¤´åƒURLã€‚
        return `/path/to/avatar/${userId}.png`; // å‡è®¾æ¯ä¸ªç”¨æˆ·å¤´åƒå‘½åä¸º userId.png
    }

    function initializeWebSocket() {
        const socketUrl = `ws://127.0.0.1:8081/groupChat?userId=${userId}&groupId=${groupId}`;
        socket = new WebSocket(socketUrl);
        socket.onopen = function() {
            console.log('ç¾¤èŠWebSocketè¿æ¥å·²æ‰“å¼€');
        };
        socket.onmessage = function(event) {
            // æ”¶åˆ°æ¶ˆæ¯
            const message = JSON.parse(event.data);
            if (message.FormId !== parseInt(userId)){
                displayMessage(message);
            }
        };
        socket.onerror = function(error) {
            console.error('WebSocketå‘ç”Ÿé”™è¯¯:', error);
        };
        socket.onclose = function() {
            console.log('WebSocketè¿æ¥å·²å…³é—­');
        };
    }

    function getUserIdFromURL() {
        const queryParams = new URLSearchParams(window.location.search);
        return queryParams.get('userId');
    }

    function getGroupIdFromURL() {
        const queryParams = new URLSearchParams(window.location.search);
        return queryParams.get('groupId');
    }


</script>awd
</body>
</html>