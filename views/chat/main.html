{{define "main.html"}}
<link rel="stylesheet" href="/asset/css/style.css">
<link rel="stylesheet" href="/asset/css/chat.css">
<div class="chat-header">
    <div class="back-arrow">&#x2190;</div> <!-- è¿”å›å›¾æ ‡ä¿æŒä¸å˜ -->
    <div class="chat-title"></div> <!-- ç”¨äºæ˜¾ç¤ºèŠå¤©æ ‡é¢˜çš„å®¹å™¨ -->
</div>
<div class="chat-messages" id="chat-messages">
    <!-- èŠå¤©è®°å½•åŠ¨æ€å¡«å……åŒºåŸŸ -->
</div>
<div class="chat-input-area">
    <input type="file" id="imageInput" hidden />
    <button id="emojiBtn">ğŸ˜Š</button>
    <!-- è¡¨æƒ…åŒ…å®¹å™¨ -->
    <div class="emoji-picker" id="emojiPicker" style="display: none;">
        <!-- è¡¨æƒ…åŒ…é¡¹å°†è¢«JSåŠ¨æ€å¡«å…… -->
    </div>
    <button id="toggleInputModeBtn">ğŸ¤</button> <!-- æ·»åŠ åˆ‡æ¢æ¨¡å¼æŒ‰é’® -->
    <div id="textMode" class="input-mode">
        <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯...">
        <button id="sendBtn">å‘é€</button>
        <button id="plusBtn">ï¼‹</button>
    </div>
    <div id="voiceMode" class="input-mode" style="display: none;">
        <button id="voiceInputBtn" class="hold-to-record">é•¿æŒ‰å½•éŸ³</button>
        <span id="recordingIndicator" style="display: none;">å½•éŸ³ä¸­...</span>
    </div>
    <div class="extra-options" id="extraOptions" style="display: none;"> <!-- é™„åŠ åŠŸèƒ½é¢æ¿ -->
        <!--        <button id="voiceInputBtn">ğŸ¤</button> &lt;!&ndash; è¯­éŸ³è¾“å…¥å›¾æ ‡ &ndash;&gt;-->
        <button id="imageBtn">ğŸ“·</button> <!-- ç§»åŠ¨ç›¸å†Œé”®å›¾æ ‡åˆ°è¿™é‡Œ -->
    </div>
</div>
<script>
    let socket = null;
    let mediaRecorder; // å…¨å±€MediaRecorderå®ä¾‹
    let isMicPermissionsGranted = false; // æ˜¯å¦å·²ç»è·å¾—éº¦å…‹é£æƒé™

    // è§£æURLå‚æ•°è·å– userId å’Œ friendName
    const userId = new URLSearchParams(window.location.search).get('userId');
    const friendId = new URLSearchParams(window.location.search).get('friendId');
    const friendName = decodeURIComponent(new URLSearchParams(window.location.search).get('friendName') || '');


    document.addEventListener('DOMContentLoaded', function() {
        //ç”³è¯·éº¦å…‹é£æƒé™
        requestMicrophoneAccess()

        // è®¾ç½®å¥½å‹å
        document.querySelector('.chat-title').innerText = friendName ? `ä¸ ${friendName} èŠå¤©ä¸­` : "èŠå¤©";

        // åˆå§‹åŒ–WebSocket
        initializeWebSocket();

        // ç»‘å®šå‘é€æŒ‰é’®äº‹ä»¶
        document.getElementById('sendBtn').addEventListener('click', sendTextMessage);

        // ä¸ºè¿”å›å›¾æ ‡ç»‘å®šç‚¹å‡»äº‹ä»¶
        document.querySelector('.back-arrow').addEventListener('click', function() {
            window.history.back();
        });

        //åŠ è½½æœ€è¿‘æ¶ˆæ¯
        loadRecentMessages();

        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');

        // æ¨¡æ‹Ÿçš„è¡¨æƒ…æ•°æ®
        const emojis = [
            "ğŸ˜€", "ğŸ˜", "ğŸ˜‚", "ğŸ¤£", "ğŸ˜ƒ", "ğŸ˜„", "ğŸ˜…", "ğŸ˜†",
            "ğŸ˜‰", "ğŸ˜Š", "ğŸ˜‹", "ğŸ˜", "ğŸ˜", "ğŸ˜˜", "ğŸ¥°", "ğŸ˜—",
            "ğŸ˜™", "ğŸ˜š", "ğŸ¥²", "ğŸ˜›", "ğŸ˜œ", "ğŸ˜", "ğŸ¤‘", "ğŸ¤—",
            "ğŸ¤­", "ğŸ¤«", "ğŸ¤”", "ğŸ¤", "ğŸ¥¸", "ğŸ˜ ", "ğŸ˜¡", "ğŸ¤¯",
            "ğŸ˜¤", "ğŸ˜ ", "ğŸ˜ˆ", "ğŸ‘¿", "ğŸ’€", "â˜ ï¸", "ğŸ˜‡", "ğŸ¥³",
            "ğŸ¥´", "ğŸ˜Œ", "ğŸ˜”", "ğŸ˜", "ğŸ¤•", "ğŸ¤’", "ğŸ˜Ÿ", "ğŸ˜¢",
            "ğŸ˜­", "ğŸ˜¦", "ğŸ˜§", "ğŸ˜®", "ğŸ˜¯", "ğŸ˜²", "ğŸ˜µ", "ğŸ˜µâ€ğŸ’«",
            "ğŸ˜³", "ğŸ¥º", "ğŸ˜´", "ğŸ˜·", "ğŸ¤’", "ğŸ¤•", "ğŸ¤¢", "ğŸ¤®",
            "ğŸ¤§", "ğŸ¥µ", "ğŸ¥¶", "ğŸ˜±", "ğŸ˜¨", "ğŸ˜°", "ğŸ˜¥", "ğŸ˜“",
            "ğŸ˜¬", "ğŸ˜©", "ğŸ˜«", "ğŸ¥„", "ğŸ´", "ğŸ”ª", "ğŸ¥£", "ğŸ½ï¸",
            "ğŸ³", "ğŸ²", "ğŸ±", "ğŸ˜", "ğŸ™", "ğŸš", "ğŸ›", "ğŸœ",
            "ğŸ", "ğŸ", "ğŸŒ", "ğŸ‰", "ğŸ‡", "ğŸ“", "ğŸˆ", "ğŸ’"
        ];

        emojis.forEach(emojiChar => {
            const emoji = document.createElement('div');
            emoji.textContent = emojiChar;
            emoji.classList.add('emoji');
            emojiPicker.appendChild(emoji);

            emoji.addEventListener('click', () => {
                const messageInput = document.getElementById('messageInput');
                messageInput.value += emojiChar; // å°†è¡¨æƒ…å­—ç¬¦æ·»åŠ åˆ°è¾“å…¥æ¡†
                emojiPicker.style.display = 'none'; // é€‰æ‹©åéšè—è¡¨æƒ…é¢æ¿
            });
        });

        emojiBtn.addEventListener('click', () => {
            emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'flex' : 'none';
        });

        // å›¾ç‰‡ä¸Šä¼ 
        document.getElementById('imageBtn').addEventListener('click', function() {
            document.getElementById('imageInput').click(); // è§¦å‘æ–‡ä»¶é€‰æ‹©
        });

        document.getElementById('imageInput').addEventListener('change', handleImageUpload);

        // æ·»åŠ åŠ å·æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬
        document.getElementById('plusBtn').addEventListener('click', function() {
            const optionsPanel = document.getElementById('extraOptions');
            optionsPanel.style.display = optionsPanel.style.display === 'none' ? 'flex' : 'none'; // åˆ‡æ¢é¢æ¿çš„æ˜¾ç¤ºçŠ¶æ€
        });

        // åˆå§‹åŒ–å˜é‡
        const voiceInputBtn = document.getElementById('voiceInputBtn');

        // åˆ‡æ¢æ–‡æœ¬è¾“å…¥å’Œè¯­éŸ³è¾“å…¥æ¨¡å¼çš„é€»è¾‘
        document.getElementById('toggleInputModeBtn').addEventListener('click', function() {
            const textMode = document.getElementById('textMode');
            const voiceMode = document.getElementById('voiceMode');
            textMode.style.display = (textMode.style.display === 'none') ? 'block' : 'none';
            voiceMode.style.display = (textMode.style.display === 'block') ? 'none' : 'block';
        });

        // äº‹ä»¶ï¼šå¼€å§‹å½•éŸ³
        voiceInputBtn.addEventListener('mousedown', prepareRecording);
        voiceInputBtn.addEventListener('touchstart', prepareRecording);






    });

    // å¤„ç†å½•éŸ³å‡†å¤‡å·¥ä½œ
    function prepareRecording() {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                startRecording(stream);
            })
            .catch(error => {
                console.error('Error accessing media devices.', error);
                alert('å½•éŸ³æƒé™è¢«æ‹’ç»æˆ–è®¾å¤‡æ— æ³•è®¿é—®ã€‚è¯·å…è®¸å½•éŸ³æƒé™ï¼Œå¹¶ç¡®ä¿è®¾å¤‡æ­£å¸¸ã€‚');
            });
    }

    // å¼€å§‹å½•éŸ³
    function startRecording(stream) {
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        voiceInputBtn.classList.add('recording');
        recordingIndicator.style.display = 'inline';

        mediaRecorder.start();
        mediaRecorder.addEventListener('dataavailable', event => {
            audioChunks.push(event.data);
        });

        // ä¸ºâ€œmouseupâ€å’Œâ€œtouchendâ€äº‹ä»¶æ·»åŠ ä¸€æ¬¡æ€§ç›‘å¬å™¨ä»¥åœæ­¢å½•éŸ³
        ['mouseup', 'touchend'].forEach(event => {
            voiceInputBtn.addEventListener(event, stopAndSendRecording, { once: true });
        });
    }

    // å‡½æ•°å®šä¹‰ï¼šåœæ­¢å½•éŸ³å¹¶ä¸Šä¼ 
    function stopAndSendRecording() {
        voiceInputBtn.classList.remove('recording');
        recordingIndicator.style.display = 'none';

        if (mediaRecorder) {
            mediaRecorder.stop();
            mediaRecorder.addEventListener('stop', () => {
                const audioBlob = new Blob(audioChunks);
                uploadAndSendAudio(audioBlob);
            });
        }
    }

    //åˆå§‹åŒ–å¹¶æ‰“å¼€WebSocketè¿æ¥
    function initializeWebSocket() {
        const socketUrl = 'ws://127.0.0.1:8081/user/sendUserMsg?userId=' + userId;
        socket = new WebSocket(socketUrl);
        socket.onopen = function() {
            console.log('WebSocketè¿æ¥å·²æ‰“å¼€');
        };

        socket.onmessage = function(event) {
            const message = JSON.parse(event.data);
            // ç¡®è®¤æ¶ˆæ¯æ˜¯å¦ä¸ºå½“å‰ç”¨æˆ·æˆ–å½“å‰æœ‹å‹æ‰€å‘é€
            if ((message.FormId.toString() === userId.toString() && message.TargetId.toString() === friendId.toString()) ||
                (message.FormId.toString() === friendId.toString() && message.TargetId.toString() === userId.toString())) {
                displayMessage(message);
            }
        };

        socket.onclose = function() {
            console.log('WebSocketè¿æ¥å·²å…³é—­');
        };

        socket.onerror = function(error) {
            console.error('WebSocketå‘ç”Ÿé”™è¯¯:', error);
        };

    }



    //å‘é€æ–‡æœ¬æ¶ˆæ¯
    function sendTextMessage() {
        const messageInput = document.getElementById('messageInput');
        const messageContent = messageInput.value.trim();

        if (messageContent && socket) {
            const message = {
                FormId: parseInt(userId),
                TargetId: parseInt(friendId),
                Type: 1,
                Media: 1,
                Content: messageContent
            };

            displayMessage({
                ...message,
                FormId: parseInt(userId)
            });

            socket.send(JSON.stringify(message));

            // åŒæ—¶å‘é€åˆ°åç«¯ MongoDB
            saveMessageToServer(message);

            messageInput.value = '';
        }
    }

    //å‘é€çš„å›¾ç‰‡ä¸Šä¼ 
    function handleImageUpload(event) {
        const file = event.target.files[0];

        if (file) {
            const formData = new FormData();
            formData.append('file', file);

            fetch('/attach/upload', {
                method: 'POST',
                body: formData,
            })
                .then(response => response.json())
                .then(data => {
                    console.log('ä¸Šä¼ æˆåŠŸ', data);
                    // æ ¹æ®è¿”å›æ•°æ®æ„å»ºå›¾ç‰‡æ¶ˆæ¯å¯¹è±¡
                    const message = {
                        FormId: parseInt(userId),
                        TargetId: parseInt(friendId),
                        Type: 1,  // 1 é€šå¸¸è¢«ç”¨æ¥è¡¨ç¤ºç§èŠï¼Œè¿™é‡ŒæŒ‰æ‚¨çš„åº”ç”¨é€»è¾‘è®¾ç½®
                        Media: 3, // 2 ä»£è¡¨å›¾ç‰‡ç±»å‹
                        Content: data.url // ä½¿ç”¨æœåŠ¡å™¨æä¾›çš„å›¾ç‰‡URL
                    };

                    // åœ¨æœ¬åœ°èŠå¤©æ¡†æ˜¾ç¤ºå›¾ç‰‡æ¶ˆæ¯
                    displayMessage({
                        ...message,
                        FormId: parseInt(userId)
                    });

                    // é€šè¿‡ WebSocket å‘é€å›¾ç‰‡æ¶ˆæ¯åˆ°å…¶ä»–å®¢æˆ·ç«¯
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify(message));
                    }

                    // è°ƒç”¨å‡½æ•°ï¼Œä¿å­˜å›¾ç‰‡æ¶ˆæ¯åˆ°æœåŠ¡å™¨
                    saveMessageToServer(message);
                })
                .catch(error => {
                    console.error('ä¸Šä¼ å¤±è´¥:', error);
                });
        }
    }

    //èŠå¤©æ¡†æ¶ˆæ¯æ˜¾ç¤º
    function displayMessage(message) {
        const chatMessages = document.getElementById('chat-messages');
        const messageContainer = document.createElement('div');
        messageContainer.classList.add('message-container');

        const avatarImg = document.createElement('img');
        avatarImg.src = "/path/to/default-avatar.png"; // ç”¨æˆ·çš„é»˜è®¤å¤´åƒè·¯å¾„
        avatarImg.classList.add('contact-avatar');

        const messageContentDiv = document.createElement('div');
        messageContentDiv.classList.add('message-content');

        switch (message.Media) {
            case 1: // æ–‡å­—æ¶ˆæ¯
                messageContentDiv.textContent = message.Content;
                break;
            case 2: // è¡¨æƒ…æ¶ˆæ¯
                messageContentDiv.textContent = message.Content;
                break;
            case 3: // å›¾ç‰‡æ¶ˆæ¯
                const img = document.createElement('img');
                img.src = message.Content;
                img.classList.add('chat-img');
                messageContentDiv.appendChild(img);
                break;
            case 4:
                const voiceContainer = document.createElement('div');
                voiceContainer.classList.add('voice-message-card');

                if (message.FormId.toString() === userId) {
                    voiceContainer.classList.add('my-message');
                } else {
                    voiceContainer.classList.add('friend-message');
                }

                const audio = document.createElement('audio');
                audio.src = message.Content;
                audio.controls = false; // éšè—é»˜è®¤æ§ä»¶
                audio.onplay = function() {
                    voiceContainer.classList.add('voice-message-playing');
                };
                audio.onpause = function() {
                    voiceContainer.classList.remove('voice-message-playing');
                };

                const controls = document.createElement('div');
                controls.classList.add('voice-message-controls');
                // const playIcon = document.createElement('span');
                // controls.appendChild(playIcon);

                const duration = document.createElement('span');
                duration.classList.add('voice-message-duration');
                duration.textContent = message.Duration; // å‡è®¾Durationæ˜¯æ ¼å¼åŒ–å¥½çš„å­—ç¬¦ä¸²

                voiceContainer.appendChild(audio);
                voiceContainer.appendChild(controls);
                voiceContainer.appendChild(duration);
                messageContentDiv.appendChild(voiceContainer);
                break;
            // å¢åŠ å…¶å®ƒæ¶ˆæ¯ç±»å‹é€»è¾‘
        }

        // åº”ç”¨è¯­éŸ³æ¶ˆæ¯æ ·å¼
        if (message.Media === 4) {
            const audioElement = document.createElement('audio');
            audioElement.src = message.Content; // è®¾ç½®éŸ³é¢‘æ¥æºä¸ºä¸Šä¼ åçš„URL
            audioElement.controls = true; // å…è®¸ç”¨æˆ·æ§åˆ¶æ’­æ”¾
            audioElement.classList.add('voice-message'); // åº”ç”¨è‡ªå®šä¹‰æ ·å¼ï¼ˆå¦‚æœæœ‰ï¼‰

            messageContentDiv.appendChild(audioElement);
        }

        // ç»„åˆæ¶ˆæ¯å®¹å™¨
        if (message.FormId.toString() === userId) {
            messageContainer.classList.add('my-message');
            messageContainer.appendChild(messageContentDiv);
            messageContainer.appendChild(avatarImg);
        } else {
            messageContainer.classList.add('friend-message');
            messageContainer.appendChild(avatarImg);
            messageContainer.appendChild(messageContentDiv);
        }

        chatMessages.appendChild(messageContainer);
        chatMessages.scrollTop = chatMessages.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°æœ€æ–°æ¶ˆæ¯

    }

    //ç”³è¯·éº¦å…‹é£æƒé™
    function requestMicrophoneAccess() {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                // åœ¨è·å¾—æƒé™åï¼Œåˆ›å»ºMediaRecorderå®ä¾‹ï¼Œä½†ä¸ç«‹å³å¼€å§‹å½•éŸ³
                mediaRecorder = new MediaRecorder(stream);
                isMicPermissionsGranted = true;
                console.log("éº¦å…‹é£è®¿é—®å·²æˆæƒã€‚");

                // å¯é€‰ï¼šå¦‚æœä½ ä¸éœ€è¦ç«‹å³ä½¿ç”¨æµï¼Œå¯ä»¥è¿™æ ·å…³é—­å®ƒã€‚
                stream.getTracks().forEach(track => track.stop());
            })
            .catch(error => {
                console.error('éº¦å…‹é£è®¿é—®é”™è¯¯:', error);
                isMicPermissionsGranted = false;
            });
    }

    // å‡½æ•°å®šä¹‰ï¼šä¸Šä¼ éŸ³é¢‘æ–‡ä»¶å¹¶å‘é€
    function uploadAndSendAudio(audioBlob) {
        const formData = new FormData();
        formData.append('audio', audioBlob);

        fetch('/user/audioUploadHandler', {
            method: 'POST',
            body: formData,
        })
            .then(response => response.json())
            .then(data => {
                if(data.url) {
                    // æ„å»ºè¯­éŸ³æ¶ˆæ¯å¯¹è±¡
                    const audioMessage = {
                        FormId: parseInt(userId),
                        TargetId: parseInt(friendId),
                        Type: 1, // 1 ä»£è¡¨ç§èŠç±»å‹æˆ–è€…æ ¹æ®ä½ åº”ç”¨çš„é€»è¾‘
                        Media: 4, // 4 è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªéŸ³é¢‘æ¶ˆæ¯
                        Content: data.url, // ä½¿ç”¨æœåŠ¡å™¨æä¾›çš„éŸ³é¢‘URL
                        Duration: data.duration, // ä½¿ç”¨æœåŠ¡å™¨è¿”å›çš„éŸ³é¢‘æŒç»­æ—¶é—´
                    };

                    // å‘é€è¯­éŸ³æ¶ˆæ¯è‡³WebSocket
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify(audioMessage));
                    }

                    // ä¿å­˜è¯­éŸ³æ¶ˆæ¯åˆ°æœåŠ¡å™¨
                    saveMessageToServer(audioMessage);

                    // å¯é€‰ï¼šæœ¬åœ°UIæ˜¾ç¤ºæ¶ˆæ¯
                    displayMessage(audioMessage);
                } else {
                    console.error("éŸ³é¢‘ä¸Šä¼ å¤±è´¥: æœåŠ¡å™¨æœªè¿”å›éŸ³é¢‘URL");
                }
            })
            .catch(error => console.error('Failed to upload audio:', error));
    }

    //åŠ è½½æœ€è¿‘æ¶ˆæ¯
    function loadRecentMessages() {
        const userId = new URLSearchParams(window.location.search).get('userId');
        const targetId = new URLSearchParams(window.location.search).get('friendId');

        fetch(`/contact/getRecentMessages?userId=${userId}&targetId=${targetId}`)
            .then(response => response.json())
            .then(data => {
                if(data && data.length) {
                    data.forEach(message => {
                        displayMessage(message); // å‡è®¾displayMessageå‡½æ•°å¯ä»¥æ­£ç¡®æ˜¾ç¤ºæ¶ˆæ¯
                    });
                    // ç¡®ä¿æ»šåŠ¨åˆ°æœ€åº•éƒ¨ï¼Œæ˜¾ç¤ºæœ€æ–°æ¶ˆæ¯
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            })
            .catch(error => console.error('åŠ è½½æœ€è¿‘æ¶ˆæ¯å¤±è´¥:', error));
    }

    //ä¿å­˜æ¶ˆæ¯åˆ°æœåŠ¡å™¨
    function saveMessageToServer(message) {
        fetch('/contact/saveMessage', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(message)
        })
            .then(response => response.json())
            .then(data => {
                if (data.Code !== 0) {
                    console.error('æ¶ˆæ¯ä¿å­˜å¤±è´¥:', data.message);
                }
            })
            .catch(error => {
                console.error('å‘é€æ¶ˆæ¯ä¿å­˜è¯·æ±‚å¤±è´¥:', error);
            });
    }
</script>
{{end}}